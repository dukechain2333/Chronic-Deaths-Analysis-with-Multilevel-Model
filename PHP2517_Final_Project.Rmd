---
title: "PHP2517 Final Project"
author: "Peirong Hao, William Qian"
output:
  pdf_document: default
header-includes: \usepackage{fvextra} \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
# https://yihui.org/knitr/options/
knitr::opts_chunk$set(message=FALSE, 
                      warning=FALSE, 
                      error=FALSE, 
                      echo = FALSE, 
                      fig.pos = "H" ,
                      fig.align = 'center',
                      tidy=TRUE, tidy.opts=list(width.cutoff=80))

library(tidyverse)
library(knitr)
set.seed(123)
library(tidyr)       ## Used to tidy data
library(dplyr)       ## Used to manipulate data
library(gtsummary)
library('caret')
library(corrplot)
library(lmerTest)
```

```{r}
library(readxl)
df.chronic <-read_excel('hosp_eolchronic_dead6699ffs_2019.xlsx')

#first convert columns to factor or numeric columns

#relevel: first level is state, second level is region
#https://www.bu.edu/brand/guidelines/editorial-style/us-state-abbreviations/
#https://www2.census.gov/geo/pdfs/maps-data/maps/reference/us_regdiv.pdf
#Note: 1 state is US(unsure), so remove that obervation

# Since the column `Hospice Days per Decedent during the Last Six Months of Life` is mislabed, we will remove it from the data

df.chronic <- df.chronic %>% select(-`Hospice Days per Decedent during the Last Six Months of Life`)

df.chronic <- df.chronic %>% mutate_if(is.character,as.factor) %>% 
  mutate(across(.cols = c(
  `SNF/Long-Term Care Sector Reimbursements per Decedent during the Last Two Years of Life`,
  `Hospice Sector Reimbursements per Decedent during the Last Two Years of Life`,
  `Total ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`,
  `High-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`,
  `Intermediate-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`,
  `Medical & Surgical Unit Bed Inputs per 1,000 Decedents during the Last Two Years of Life`,
  `SNF Bed Inputs per 1,000 Dededents during the Last Two Years of Life`,,
  `RNs Required Under Proposed Federal Standards per 1,000 Decedents during the Last Two Years of Life`,
  `High-Intensity ICU Days per Decedent during the Last Six Months of Life`,
  `Intermediate-Intensity ICU Days per Decedent during the Last Six Months of Life`,
  `Medical & Surgical Unit Days per Decedent during the Last Six Months of Life`,
  `Percent of Decedents Enrolled In Hospice during the Last Six Months of Life`),~as.numeric(.)))%>%
  mutate(Region = case_when(State %in% c("CT","ME","MA","NH","RI","VT","NJ","NY","PA") ~ "Northeast",
                            State %in% c("IN","IL","MI","OH","WI","IA","KS","MN","MO","NE","ND","SD") ~ "Midwest",
                            State %in% c("DE","DC","FL","GA","MD","NC","SC","VA","WV","AL","KY","MS","TN","AR","LA","OK","TX") ~ "South",
                            State %in% c("AZ","CO","ID","NM","MT","UT","NV","WY","AK","CA","HI","OR","WA") ~ "West"),
         Region = factor(Region))%>% 
  filter(State!="US")
  # filter(!is.na(Region))

# summary(df.chronic)
# summary(df.chronic$State)
# summary(df.chronic$Region)

#proposal: association between variables and outcome, clear y, x 
#model selection: aic, model assumption 


# Level 1: State
# Level 2: Region
```

```{r}
# check which cols have na values
na_cols <- colnames(df.chronic)[colSums(is.na(df.chronic)) > 0]

# check the ratio of NAs in these columns
na_ratio <- colSums(is.na(df.chronic[na_cols])) / nrow(df.chronic)
na_ratio
```

```{r}
# since `System` has 20% missing values, we are going to remove this column
df.chronic <- df.chronic %>% select(-System)

# `Ambulance spending per Decedent during the last two years of life` has 0.4% missing values, we are going to remove these rows
df.chronic <- df.chronic %>% drop_na(`Ambulance spending per Decedent during the last two years of life`)
```


```{r}
library(kableExtra)

overall_summary <- df.chronic %>%
  group_by(Region, State) %>% 
  summarise(
  n = (length(`Number of deaths among chronically ill patients assigned to hospital`)-sum(is.na(`Number of deaths among chronically ill patients assigned to hospital`))),
  total = sum(`Number of deaths among chronically ill patients assigned to hospital`, na.rm = T),
  mean = round(mean(`Number of deaths among chronically ill patients assigned to hospital`, na.rm = T), 3),
  sd = round(sd(`Number of deaths among chronically ill patients assigned to hospital`, na.rm = T), 3),
  median = round(median(`Number of deaths among chronically ill patients assigned to hospital`, na.rm = T), 3),
  min = round(min(`Number of deaths among chronically ill patients assigned to hospital`, na.rm = T), 3),
  max = round(max(`Number of deaths among chronically ill patients assigned to hospital`, na.rm = T), 3))%>%
  ungroup()

#output table for overall averages
overall_summary %>%
  mutate_all(linebreak) %>%
  kbl(caption = "Summary of Number of deaths",
  col.names=linebreak(c("Region", "State", "N", "Total", "Mean", "SD", "Median", "Min", "Max")),
  booktabs=T, escape=F, align = "c") %>%
kable_styling(full_width = FALSE, latex_options = c('hold_position'))

overall_summary
```

```{r}
df.chronic %>%
  group_by(State) %>%
  summarise(var_dead = var(`Number of deaths among chronically ill patients assigned to hospital`)) %>%
  ggplot(aes(x = State, y = var_dead)) +
  geom_bar(stat = "identity") +
  labs(title = "Variance of Number of deaths by States",
       x = "States",
       y = "Variance of Number of deaths") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
df.chronic %>%
  group_by(Region) %>%
  summarise(var_dead = var(`Number of deaths among chronically ill patients assigned to hospital`)) %>%
  ggplot(aes(x = Region, y = var_dead)) +
  geom_bar(stat = "identity") +
  labs(title = "Variance of Number of deaths by Region",
       x = "States",
       y = "Variance of Number of Region") +
  theme_minimal()
```

```{r}
#"Hospital Name"
cols_to_drop <- c("HRR", "HRR Name", "Provider ID", "City", "Inpatient Sector Reimbursements per Decedent during the Last Two Years of Life", "Outpatient Sector Reimbursements per Decedent during the Last Two Years of Life", "SNF/Long-Term Care Sector Reimbursements per Decedent during the Last Two Years of Life", "Home Health Sector Reimbursements per Decedent during the Last Two Years of Life", "Hospice Sector Reimbursements per Decedent during the Last Two Years of Life", "Reimbursements for Durable Medical Equipment per Decedent during the Last Two Years of Life", "Ambulance spending per Decedent during the last two years of life", "Part B Spending for Evaluation & Management per Decedent during the Last Two Years of Life","Part B Spending for Procedures per Decedent during the Last Two Years of Life", "Part B Spending for Imaging per Decedent during the Last Two Years of Life", "Part B Spending for Tests per Decedent during the Last Two Years of Life", "Other Part B spending per Decedent during the last two years of life", "Inpatient Days per Decedent during the Last Two Years of Life", "Reimbursements per patient day (calculated)", "Reimbursements per Day: Ratio to US Average (calculated)", "Hospital reimbursements per Decedent during the last two years of life", "Payments per physician visit (calculated)", "Payments for physician visits per Decedent during the last two years of life", "Physician Visits per Decedent during the Last Two Years of Life", "Payments per visit: Ratio to US Average (calculated)", "FTE Physician Labor Inputs per 1,000 Decedents during the Last Two Years of Life", "FTE Medical Specialist Labor Inputs per 1,000 Decedents during the Last Two Years of Life", "FTE Primary Care Physician Labor Inputs per 1,000 Decedents during the Last Two Years of Life", "Average Co-Payments for Physician Services per Decedent during the Last Two Years of Life", "Average Co-Payments for Durable Medical Equipment per Decedent during the Last Two Years of Life", "Percent of Deaths Occurring In Hospital", "Percent of Deaths Associated With ICU Admission", "Physician Visits per Decedent during the Last Six Months of Life", "Medical Specialist Visits per Decedent during the Last Six Months of Life", "Primary Care Visits per Decedent during the Last Six Months of Life", "Percent of Decedents Seeing 10 or More Different Physicians during the Last Six Months of Life")

df.chronic <- df.chronic %>% select(-cols_to_drop)
```


```{r}
df.chronic[df.chronic<0] <- NA
# add check for proportion of zeros in each column!!!
df.chronic <- df.chronic %>% drop_na()
```

```{r}
df.chronic %>%
  select(-State) %>%
  group_by(Region) %>%
  summarize_all(~mean(., na.rm = TRUE))
```

```{r}
df.summary<-df.chronic %>% select(-c(State,`Hospital Name`)) %>%
  tbl_summary(missing="no",
              by = Region, 
              type = list(where(is.numeric) ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% add_p()%>%
  modify_caption("Summary of Variables by Region")
df.summary
```

```{r}
plot_correlation <- function(df){
  dat <- as.matrix(df)
  dimnames(dat) <- list(rep("", ncol(dat)), rep("", ncol(dat)))
  dat[upper.tri(dat)] <- 0
  
  corrplot(dat, type = "lower" , title="Correlation Plot", mar=c(0,0,0,0), cex.main=0.7, number.cex=0.7, tl.cex = 0.7, cl.cex = 0.7)
}
```

```{r}
df.numeric <- df.chronic %>%  select_if(is.numeric)
df.cat <- df.chronic  %>% select_if(is.factor)

cor.df.numeric <- cor(df.numeric, use = "complete.obs")
plot_correlation(cor.df.numeric)
```

```{r}
# remove highly correlated variables
hc <- findCorrelation(cor.df.numeric, cutoff=0.3)
hc <- sort(hc)
df.numeric <- df.numeric[,-c(hc)]

cor.df.numeric <- cor(df.numeric, use = "complete.obs")
plot_correlation(cor.df.numeric)

# combine it with categorical variables
df.cat <- df.chronic  %>% select_if(is.factor)

df.chronic <- cbind(df.cat, df.numeric)

col.df<-colnames(df.chronic)
col.df
```

```{r}
df.summary.region<-df.chronic %>% select(-c(State,`Hospital Name`)) %>%
  tbl_summary(missing="no",
              by = Region, 
              type = list(where(is.numeric) ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% add_p()%>%
  modify_caption("Summary of Variables by Region")
df.summary.region
```

```{r}
df.summary.state<-df.chronic %>% select(-c(Region,`Hospital Name`)) %>%
  tbl_summary(missing="no",
              by = State, 
              type = list(where(is.numeric) ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% add_p()%>%
  modify_caption("Summary of Variables by State")
df.summary.state
```

$Y_{ij}\sim N(\beta_j, \sigma^2), \beta_j\sim N(\mu,\tau^2)$ 

```{r}
library(lme4)
m1<-lmer(`Number of deaths among chronically ill patients assigned to hospital` ~1+(1|State),data=df.chronic)
summ1<-summary(m1)
```

* Summary table
```{r}
VarCorr(m1)
```

```{r}
summ1$coefficients
```

```{r}
m2<-lmer(`Number of deaths among chronically ill patients assigned to hospital` ~1+(1|Region),data=df.chronic)
summ2<-summary(m2)
```

* Summary table
```{r}
VarCorr(m2)
```

```{r}
summ2$coefficients
```

```{r}
AIC(m1,m2)
```

Because m1 has a slighly lower AIC value, m1 is the better model. Intercept variance = $(35.544)^2 = 1263.376$ represents how much variance in outcome (number of deaths) that is explained between states. Residual variance = $(219.670)^2 = 48254.91$ represents the within state unexplained variance. $\beta_{0}+b_{0j}=305.5872+b_{0j}$ represents the estimated number of deaths (individual intercept) for the jth state.

```{r}
#???
m.full<-lmer(`Number of deaths among chronically ill patients assigned to hospital` ~1+
                       `Other spending per Decedent during the last two years of life`+
               `Total ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`+
               `High-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`+
               `Intermediate-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`+
               `SNF Bed Inputs per 1,000 Dededents during the Last Two Years of Life`+
               `Standardized FTE physician labor: Ratio MS/PC (calculated)`+
               `Medical & Surgical Unit Days per Decedent during the Last Six Months of Life`+
               `Home Health Agency Visits per Decedent during the Last Six Months of Life`+
               `Percent of Decedents Enrolled In Hospice during the Last Six Months of Life`+
               (1|State)+
               (0+`Other spending per Decedent during the last two years of life`|`Hospital Name`)+
               (0+`Total ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`|`Hospital Name`)+
               (0+`High-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`|`Hospital Name`)+
               (0+`Intermediate-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life`|`Hospital Name`)+
               (0+`SNF Bed Inputs per 1,000 Dededents during the Last Two Years of Life`|`Hospital Name`)+
               (0+`Standardized FTE physician labor: Ratio MS/PC (calculated)`|`Hospital Name`)+
               (0+`Medical & Surgical Unit Days per Decedent during the Last Six Months of Life`|`Hospital Name`)+
               (0+`Home Health Agency Visits per Decedent during the Last Six Months of Life`|`Hospital Name`)+
               (0+`Percent of Decedents Enrolled In Hospice during the Last Six Months of Life`|`Hospital Name`),data=df.chronic)
summ.full<-summary(m.full)
```

```{r}
step(m.full)#backward selection for random effects
```

```{r}
#remove random intercepts???
m.best<-lmer(`Number of deaths among chronically ill patients assigned to hospital` ~ 
               `Other spending per Decedent during the last two years of life` + 
               `High-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life` + 
               `SNF Bed Inputs per 1,000 Dededents during the Last Two Years of Life` + 
               `Standardized FTE physician labor: Ratio MS/PC (calculated)` + 
               `Medical & Surgical Unit Days per Decedent during the Last Six Months of Life` + 
               `Percent of Decedents Enrolled In Hospice during the Last Six Months of Life` + 
               (0 + `Other spending per Decedent during the last two years of life` | `Hospital Name`) + 
               (0 + `Total ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life` | `Hospital Name`) + 
               (0 + `High-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life` | `Hospital Name`) + 
               (0 + `Intermediate-Intensity ICU Bed Inputs per 1,000 Decedents during the Last Two Years of Life` | `Hospital Name`) + 
               (0 + `SNF Bed Inputs per 1,000 Dededents during the Last Two Years of Life` |      `Hospital Name`) + 
               (0 + `Standardized FTE physician labor: Ratio MS/PC (calculated)` | `Hospital Name`) + 
               (0 + `Medical & Surgical Unit Days per Decedent during the Last Six Months of Life` | `Hospital Name`) + 
               (0 + `Home Health Agency Visits per Decedent during the Last Six Months of Life` | `Hospital Name`) + 
               (0 + `Percent of Decedents Enrolled In Hospice during the Last Six Months of Life` | `Hospital Name`), data=df.chronic)
summ.best<-summary(m.best)
```

* Fixed effects:

```{r}
m.fixef<-fixef(m.best)
m.fixef
```

* Random effects for first 5 hospitals:

```{r}
m.ranef<-ranef(m.best)[[1]]
m.ranef[1:5,]
```

```{r}
#TODO: plot predicted value, redo hw2,hw3 plots
m.best.predict <- predict(m.best)

# Find the mse:
mse <- mean((df.chronic$`Number of deaths among chronically ill patients assigned to hospital` - m.best.predict)^2)
```

```{r}
```


# Code Appendix

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
